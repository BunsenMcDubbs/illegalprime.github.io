<!DOCTYPE html>
<html>
<head>
	<link href="http://gmpg.org/xfn/11" rel="profile">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<link rel="canonical" href="https://illegalprime.github.io//blog/wireless-sharing" />
	<meta name="description" content="# Intro I have spent a long long while looking for solutions to this problem over the great Linux forums,..." />
	<meta property="og:description" content="# Intro I have spent a long long while looking for solutions to this problem over the great Linux forums,..." />
	<meta itemprop="image" content="https://illegalprime.github.io//media/2014-08-07-wireless-sharing/cover.png" />
	<meta property="og:image" content="https://illegalprime.github.io//media/2014-08-07-wireless-sharing/cover.png" />
	<meta property="og:title" content="WiFi Sharing in Linux with two wireless cards" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://illegalprime.github.io//blog/wireless-sharing" />
	<meta property="og:site_name" content="Michael Eden" />
	<title>WiFi Sharing in Linux with two wireless cards &middot; Michael Eden</title>
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="HandheldFriendly" content="True" />
	<meta name="MobileOptimized" content="320" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta property="fb:app_id" content="1482009368710102"/>
	<link rel="stylesheet" type="text/css" media="only screen and (min-width: 1001px)" href="/assets/css/desktop.css" />
	<link rel="stylesheet" type="text/css" media="only screen and (max-width: 1000px)" href="/assets/css/mobile.css" />
	<link href="/assets/css/genericons.css" type="text/css" rel="stylesheet" />
	<link href="/assets/css/syntax.css" type="text/css" rel="stylesheet" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
	<link rel="apple-touch-icon" href="https://illegalprime.github.io//assets/images/icon.png">
	<link rel="shortcut icon" href="https://illegalprime.github.io//assets/images/favicon.ico">
	<link rel="alternate" type="application/rss+xml" title="RSS" href="https://illegalprime.github.io//atom.xml">
	<script type="text/javascript" src="/assets/js/additions.js"></script>
</head>


<body>
	<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=1482009368710102&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div id='following_menu' style="background-image: url(/media/2014-08-07-wireless-sharing/cover.png); background-position: 0%  30% ;">
	<div id="following_overlay">
		<div id="following_social_container">
			
<a href="mailto:themichaeleden@gmail.com" target="" title="Email me"><span class="genericon genericon-mail"></span></a>

<a href="https://github.com/illegalprime" target=" _blank " title="Fork me on GitHub"><span class="genericon genericon-github"></span></a>

<a href="https://plus.google.com/+MichaelEdenIsGreat" target=" _blank " title="Add me on Google+"><span class="genericon genericon-googleplus-alt"></span></a>

<a href="http://illegalprime.github.io/atom.xml" target=" _blank " title="Subscribe to my Feed (Atom)"><span class="genericon genericon-feed"></span></a>

		</div>
		<div id="following_menu_container">
			<div class="menu_bar">
	
		<a  class='menu_normal' onmouseover="this.className='menu_highlighted'" onmouseout="this.className='menu_normal'"  href="/">Home</a>
	
		<a  class='menu_normal' onmouseover="this.className='menu_highlighted'" onmouseout="this.className='menu_normal'"  href="/archive">Archive</a>
	
		<a  class='menu_normal' onmouseover="this.className='menu_highlighted'" onmouseout="this.className='menu_normal'"  href="/categories">By Category</a>
	
		<a  class='menu_normal' onmouseover="this.className='menu_highlighted'" onmouseout="this.className='menu_normal'"  href="/contact">Contact Me</a>
	
		<a  class='menu_normal' onmouseover="this.className='menu_highlighted'" onmouseout="this.className='menu_normal'"  href="/about">About</a>
	
</div>

		</div>
	</div>
</div>
<header class="clean" style="background-image: url(/media/2014-08-07-wireless-sharing/cover.png);height: 100%;">
	
	<!--
<label class="menu" for="_1">
	<span class="genericon genericon-menu"></span>
</label>
<input id="_1" type="checkbox">
<div class="menu-content">
	<div class="menu" style="background-color: #777; z-index: 2;"></div>
	
	<a href="/">Home</a><br>
	
	<a href="/archive">Archive</a><br>
	
	<a href="/categories">By Category</a><br>
	
	<a href="/contact">Contact Me</a><br>
	
	<a href="/about">About</a><br>
	
</div>-->

<!--<div class="menu-content">
	
	<a href="/">Home</a><br>
	
	<a href="/archive">Archive</a><br>
	
	<a href="/categories">By Category</a><br>
	
	<a href="/contact">Contact Me</a><br>
	
	<a href="/about">About</a><br>
	
</div>-->

<div class="social-links">
	
<a href="mailto:themichaeleden@gmail.com" target="" title="Email me"><span class="genericon genericon-mail"></span></a>

<a href="https://github.com/illegalprime" target=" _blank " title="Fork me on GitHub"><span class="genericon genericon-github"></span></a>

<a href="https://plus.google.com/+MichaelEdenIsGreat" target=" _blank " title="Add me on Google+"><span class="genericon genericon-googleplus-alt"></span></a>

<a href="http://illegalprime.github.io/atom.xml" target=" _blank " title="Subscribe to my Feed (Atom)"><span class="genericon genericon-feed"></span></a>

</div>
	<div id='top_menu'>
	<div class="menu_bar">
	
		<a  class='menu_normal' onmouseover="this.className='menu_highlighted'" onmouseout="this.className='menu_normal'"  href="/">Home</a>
	
		<a  class='menu_normal' onmouseover="this.className='menu_highlighted'" onmouseout="this.className='menu_normal'"  href="/archive">Archive</a>
	
		<a  class='menu_normal' onmouseover="this.className='menu_highlighted'" onmouseout="this.className='menu_normal'"  href="/categories">By Category</a>
	
		<a  class='menu_normal' onmouseover="this.className='menu_highlighted'" onmouseout="this.className='menu_normal'"  href="/contact">Contact Me</a>
	
		<a  class='menu_normal' onmouseover="this.className='menu_highlighted'" onmouseout="this.className='menu_normal'"  href="/about">About</a>
	
</div>

</div>
	<div id="post-info">
		<h1>WiFi Sharing in Linux with two wireless cards</h1>
		
		<a class="site-title" href="https://illegalprime.github.io/"><img src="/assets/images/icon.png" class="site-icon-small">Michael Eden</a>
	</div>
	<div id="nav-icon">
		<a class="scroll" data-speed="1000" href="#article"><span class="genericon genericon-expand"></span></a>
	</div>
</header>
<div id="article" class="" >
	<h1>Intro</h1>

<p>I have spent a long long while looking for solutions to this problem over the great Linux forums, and in truth its not easy to do. Most of the scripts I&#39;ve come across did not work, but from all this experience I&#39;ve pieced together a collection of DHCPD rules and <code>iptable</code> commands that should allow you to use <code>airbase-ng</code> to create a WiFi hotspot with optional WEP Encryption.</p>

<p>So here it is.</p>

<h1>Prerequisites</h1>

<p>In order to have this script run successfully you will need:</p>

<h2>The Hardware</h2>

<ul>
<li>A wireless card or Ethernet card that is connected to the Internet.</li>
<li>Another wireless card that can be put into monitor mode</li>
<li>Kali Linux (Recommended)</li>
</ul>

<h2>The Software</h2>

<ul>
<li>The <code>aircrack-ng</code> suite, notably <code>airbase-ng</code>.</li>
<li><code>mitmproxy</code> available by issuing  <code>sudo pip2 install mitmproxy</code></li>
<li><code>dhcpd</code> which is <strong>not</strong> available in Kali by default and one can install it through <code>apt-get install isc-dhcp-server</code></li>
</ul>

<h1>The Script</h1>

<h2>Variable Names</h2>

<ul>
<li><code>LAN_IF</code> is the interface connected to the Internet.</li>
<li><code>LAN_GATEWAY</code> is the IP of the main router to which <code>LAN_IF</code> connects to.</li>
<li><code>AP_IF</code> is the monitor mode capable interface.</li>
<li><code>AP_CHANNEL</code> specifies the wireless channel of the AP.</li>
<li><code>AP_ESSID</code> is the AP name.</li>
<li><code>AP_GATEWAY</code> is the router IP clients connected to the AP will see.</li>
<li>For a range of IPs of <code>AP_RANGE</code> given to the clients, <code>AP_SUBNET</code> and <code>AP_NETMASK</code> should stay the same.</li>
<li><code>AP_MTU</code> is the <a href="https://en.wikipedia.org/wiki/Maximum_transmission_unit">MTU</a>.</li>
<li>Finally <code>MITMPROXY_FLAGS</code> are the arguments that get appended on to mitmproxy at runtime.</li>
</ul>

<p>Change these arguments to fit your needs. Also if you want WPA/WPA2 encryption, use <a href="http://nims11.wordpress.com/2012/04/27/hostapd-the-linux-way-to-create-virtual-wifi-access-point/">hostapd</a> with a suitable Atheros wireless card.</p>

<h2>The Entire Script</h2>
<div class="highlight"><pre><code class="language-BASH" data-lang="BASH"><span class="c">#!/bin/bash</span>
<span class="nv">LAN_IF</span><span class="o">=</span>wlan1
<span class="nv">LAN_GATEWAY</span><span class="o">=</span><span class="k">$(</span>ip -4 route list <span class="nb">type </span>unicast dev <span class="nv">$LAN_IF</span> exact 0/0 <span class="p">|</span> cut -d <span class="s1">&#39; &#39;</span> -f 3<span class="k">)</span>

<span class="nv">AP_IF</span><span class="o">=</span>wlan0
<span class="nv">AP_CHANNEL</span><span class="o">=</span>6
<span class="nv">AP_ESSID</span><span class="o">=</span><span class="s1">&#39;Do not connect to&#39;</span>
<span class="nv">AP_GATEWAY</span><span class="o">=</span><span class="s1">&#39;192.168.2.1&#39;</span>
<span class="nv">AP_SUBNET</span><span class="o">=</span><span class="s1">&#39;192.168.2.0&#39;</span>
<span class="nv">AP_NETMASK</span><span class="o">=</span><span class="s1">&#39;255.255.255.0&#39;</span>
<span class="nv">AP_RANGE</span><span class="o">=</span><span class="s1">&#39;192.168.2.2 192.168.2.255&#39;</span>
<span class="nv">AP_MTU</span><span class="o">=</span>1400

<span class="nv">MITMPROXY_FLAGS</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="c">#MITMPROXY_FLAGS=&quot;-s /root/Desktop/image_local.py&quot;</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$(id -u)&quot;</span> !<span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
    <span class="nb">echo</span> <span class="s2">&quot;Run it as root.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

ifconfig <span class="nv">$AP_IF</span> down
iwconfig <span class="nv">$AP_IF</span> mode monitor channel <span class="nv">$AP_CHANNEL</span>
ifconfig <span class="nv">$AP_IF</span> up

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$(iwconfig $AP_IF | grep -o Mode:Monitor)&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;[FAIL] Could not put interface $AP_IF in monitor mode.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;       Exiting...&quot;</span>
    <span class="nb">exit</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;[ OK ] monitor mode on interface $AP_IF.&quot;</span>
    sleep 1
<span class="k">fi</span>

xterm -geometry 75x15+1+0 -T <span class="s2">&quot;Airbase - $AP_ESSID - $AP_IF&quot;</span> <span class="se">\</span>
       -e <span class="s2">&quot;airbase-ng -c $AP_CHANNEL -e &#39;$AP_ESSID&#39; $AP_IF&quot;</span> <span class="p">&amp;</span>
<span class="nv">AIRBASE_PID</span><span class="o">=</span><span class="nv">$!</span>
sleep 3

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$(ps -A | grep -o $AIRBASE_PID)&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;[FAIL] Cannot find airbase-ng, quitting.&quot;</span>
    <span class="nb">exit</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;[ OK ] Started airbase-ng&quot;</span>
<span class="k">fi</span>

ifconfig lo up
ifconfig at0 up
sleep 1
ifconfig at0 <span class="nv">$AP_GATEWAY</span> netmask <span class="nv">$AP_NETMASK</span>
ifconfig at0 mtu <span class="nv">$AP_MTU</span>
route add -net <span class="nv">$AP_SUBNET</span> netmask <span class="nv">$AP_NETMASK</span> gw <span class="nv">$AP_GATEWAY</span>

iptables --flush
iptables --table nat --flush
iptables --delete-chain
iptables --table nat --delete-chain

<span class="nb">echo </span><span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward

iptables -t nat -A PREROUTING -p udp -j DNAT --to <span class="nv">$LAN_GATEWAY</span>
iptables -P FORWARD ACCEPT
iptables --append FORWARD --in-interface at0 -j ACCEPT
iptables --table nat --append POSTROUTING --out-interface <span class="nv">$LAN_IF</span> -j MASQUERADE
iptables -t nat -A PREROUTING -p tcp --destination-port <span class="m">80</span> <span class="se">\</span>
         -j REDIRECT --to-port 8080

<span class="nb">echo</span> <span class="s2">&quot;[ OK ] IP table rules set.&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;authoritative;</span>

<span class="s2">default-lease-time 600;</span>
<span class="s2">max-lease-time 7200;</span>

<span class="s2">subnet $AP_SUBNET netmask $AP_NETMASK {</span>
<span class="s2">    option routers $AP_GATEWAY;</span>
<span class="s2">    option subnet-mask $AP_NETMASK;</span>
<span class="s2">    option domain-name \&quot;$AP_ESSID\&quot;;</span>
<span class="s2">    option domain-name-servers $LAN_GATEWAY;</span>
<span class="s2">    range $AP_RANGE;</span>
<span class="s2">}</span>
<span class="s2">&quot;</span> &gt; /etc/dhcpd-rogue.conf

<span class="nb">echo</span> <span class="s2">&quot;[ OK ] Adding DHCPD configuration.&quot;</span>

touch /var/run/dhcpd.pid
xterm -geometry 75x20+1+100 -T DHCP <span class="se">\</span>
      -e dhcpd -d -f -cf <span class="s2">&quot;/etc/dhcpd-rogue.conf&quot;</span> -pf <span class="s2">&quot;/var/run/dhcpd.pid&quot;</span> at0 <span class="p">&amp;</span> 
<span class="nv">DHCPD_PID</span><span class="o">=</span><span class="nv">$!</span>
sleep 3

<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;[FAIL] DHCPD Failed to start.&quot;</span>
    <span class="nb">exit</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;[ OK ] Started DHCPD Server&quot;</span>
<span class="k">fi</span>

mitmproxy -T --host --anticache -p <span class="m">8080</span> <span class="nv">$MITMPROXY_FLAGS</span>
<span class="c">#echo &quot;Hit Enter to tear down the network.&quot;</span>
<span class="c">#read</span>
<span class="nb">echo</span> <span class="s2">&quot;Cleaning up...&quot;</span>

<span class="nb">kill</span> -SIGINT <span class="k">$(</span>cat /var/run/dhcpd.pid<span class="k">)</span>
<span class="nb">kill</span> -SIGINT <span class="nv">$AIRBASE_PID</span>

ifconfig <span class="nv">$AP_IF</span> down
iwconfig <span class="nv">$AP_IF</span> mode managed
ifconfig <span class="nv">$AP_IF</span> up

<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/ip_forward
iptables --flush
iptables --table nat --flush
iptables --delete-chain
iptables --table nat --delete-chain

<span class="nb">echo</span> <span class="s2">&quot;Done.&quot;</span>
</code></pre></div>
<p>This had worked for me in Kali Linux when this post was published, so please comment if anything stops working.</p>

<p>&mdash; Michael</p>


	<br/><br/>
	<h2>Say It Loud! Leave a comment below:</h2>
	<div class="fb-comments" data-href="https://illegalprime.github.io//blog/wireless-sharing" data-width="100%" data-numposts="10" data-colorscheme="light"></div>
</div>


<footer class="clean" style="background-image: url(/media/2014-08-04-stickshifts-n-safetybelts/cover.jpg);height: 75%; min-height: 500px;">
	<div id="nav-icon" style="top: 25px;">
		<a class="scroll" data-speed="1000" href="#article"><span class="genericon genericon-collapse"></span></a>
	</div>
	<div id="post-info">
		<h3>Featured post</h3>
		<a href="/blog/bitshifts-n-safetybelts">
			<h1>Bitshifts & Safetybelts</h1>
			
				<h2>Image: Savannah GA, alligators hiding in the marsh.</h2>
			
		</a>
	</div>
	<p class="copyright">&copy;2014, <a href="http://camporez.com" target="_blank">Camporez</a>. <a href="http://creativecommons.org/licenses/by-nc/2.5" target="_blank">Some rights reserved</a>.</p>
</footer>

<script src="/assets/js/smooth-scroll.js"></script>

</body>
</html>